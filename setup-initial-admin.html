<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆæœŸç®¡ç†è€…ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— - æ¡œç”ºä¸­å­¦æ ¡1976å¹´å’æ¥­åŒçª“ä¼š</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <script src="assets/js/firebase-config.js"></script>
</head>
<body>
    <div class="password-container">
        <h2>ğŸ”§ åˆæœŸç®¡ç†è€…ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</h2>
        <p style="color: #e53e3e; font-weight: bold;">âš ï¸ ã“ã®ãƒšãƒ¼ã‚¸ã¯åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å°‚ç”¨ã§ã™</p>
        
        <div class="form-group">
            <label for="setup-email">ç®¡ç†è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
            <input type="email" id="setup-email" placeholder="admin@example.com" required>
        </div>
        <div class="form-group">
            <label for="setup-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="setup-password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" required>
        </div>
        <div class="form-group">
            <label for="setup-name">ç®¡ç†è€…å</label>
            <input type="text" id="setup-name" placeholder="ç®¡ç†è€…å" required>
        </div>
        <button onclick="setupInitialAdmin()" class="submit-button">åˆæœŸç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆ</button>

        <div id="setup-status" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; display: none;">
            <p id="status-message"></p>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 5px; font-size: 0.9rem;">
            <p><strong>ä½¿ç”¨æ–¹æ³•:</strong></p>
            <ol>
                <li>ç®¡ç†è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€åå‰ã‚’å…¥åŠ›</li>
                <li>ã€ŒåˆæœŸç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>ä½œæˆå®Œäº†å¾Œã€ã“ã®ãƒšãƒ¼ã‚¸ã¯å‰Šé™¤ã—ã¦ãã ã•ã„</li>
                <li><a href="admin.html" style="color: #3182ce;">ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>ã§ãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆ</li>
            </ol>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebaseè¨­å®šã‚’ä½¿ç”¨
        const firebaseConfig = window.FIREBASE_CONFIG;

        // FirebaseåˆæœŸåŒ–
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.setupInitialAdmin = async function() {
            const email = document.getElementById('setup-email').value.trim();
            const password = document.getElementById('setup-password').value;
            const name = document.getElementById('setup-name').value.trim();

            if (!email || !password || !name) {
                showStatus('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            if (password.length < 6) {
                showStatus('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
                return;
            }

            try {
                showStatus('ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œæˆä¸­...', 'info');

                // Firebase Authentication ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Firestore ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ç®¡ç†è€…ã¨ã—ã¦ä¿å­˜
                await setDoc(doc(db, 'users', user.uid), {
                    name: name,
                    email: email,
                    graduationYear: '',
                    phone: '',
                    address: '',
                    job: '',
                    bio: '',
                    isPublic: true,
                    role: 'admin',  // ç®¡ç†è€…ã¨ã—ã¦è¨­å®š
                    createdAt: serverTimestamp(),
                    isInitialAdmin: true
                });

                showStatus(`âœ… åˆæœŸç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸï¼\\n\\nãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: ${email}\\n\\nä»Šã™ãç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆã‚’è¡Œã„ã€ãã®å¾Œã“ã®ãƒšãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚`, 'success');

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('setup-email').value = '';
                document.getElementById('setup-password').value = '';
                document.getElementById('setup-name').value = '';

            } catch (error) {
                console.error('Setup error:', error);
                let errorMessage = 'ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒå¼±ã™ãã¾ã™ã€‚';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'ç„¡åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™ã€‚';
                }
                
                showStatus(errorMessage, 'error');
            }
        };

        function showStatus(message, type) {
            const statusDiv = document.getElementById('setup-status');
            const messageP = document.getElementById('status-message');
            
            messageP.textContent = message;
            statusDiv.style.display = 'block';
            
            if (type === 'success') {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
            } else {
                statusDiv.style.background = '#cce7ff';
                statusDiv.style.color = '#004085';
                statusDiv.style.border = '1px solid #99d6ff';
            }
        }
    </script>
</body>
</html>