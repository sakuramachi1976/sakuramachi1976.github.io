<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理者ダッシュボード | 桜町中学校1976年卒業同窓会</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <!-- Firebase設定読み込み -->
    <script src="assets/js/firebase-config.js"></script>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .admin-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .admin-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
        }
        .admin-tab {
            flex: 1;
            padding: 10px 15px;
            background: none;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .admin-tab.active {
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .admin-content {
            display: none;
        }
        .admin-content.active {
            display: block;
        }
        .user-item, .content-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        .user-item:last-child, .content-item:last-child {
            border-bottom: none;
        }
        .user-info {
            flex: 1;
        }
        .user-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .user-details {
            font-size: 0.9rem;
            color: #666;
        }
        .admin-actions {
            display: flex;
            gap: 10px;
        }
        .btn-admin {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        .btn-edit { background: #28a745; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-approve { background: #007bff; color: white; }
        .btn-admin:hover { opacity: 0.8; }
        .access-denied {
            text-align: center;
            padding: 100px 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- 管理者認証画面 -->
    <div id="admin-login-screen" class="password-container">
        <h2>管理者ログイン</h2>
        <p>管理者のみアクセス可能です。</p>
        
        <div class="form-group">
            <label for="admin-email">管理者メールアドレス</label>
            <input type="email" id="admin-email" placeholder="admin@example.com" required>
        </div>
        <div class="form-group">
            <label for="admin-password">パスワード</label>
            <input type="password" id="admin-password" placeholder="パスワードを入力" required>
        </div>
        <button onclick="adminLogin()" class="submit-button">管理者ログイン</button>

        <div id="admin-error-message" class="error-message" style="display:none;"></div>
        
        <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 5px; font-size: 0.9rem;">
            <p><strong>管理者について:</strong></p>
            <p>このページは同窓会事務局の管理者のみがアクセスできます。<br>
            一般会員の方は<a href="members.html" style="color: #3182ce;">会員専用ページ</a>をご利用ください。</p>
        </div>
    </div>

    <!-- アクセス拒否画面 -->
    <div id="access-denied-screen" style="display:none;">
        <div class="access-denied">
            <h2>🚫 アクセス拒否</h2>
            <p>このページにアクセスする権限がありません。</p>
            <p>管理者権限が必要です。</p>
            <button onclick="window.location.href='members.html'" class="submit-button">会員専用ページに戻る</button>
        </div>
    </div>

    <!-- 管理者ダッシュボード -->
    <div id="admin-dashboard" style="display:none;">
        <header style="background: #2c3e50; color: white; padding: 20px 0;">
            <div class="admin-container">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 style="margin: 0; font-size: 1.5rem;">管理者ダッシュボード</h1>
                        <p style="margin: 5px 0 0 0; opacity: 0.8;">桜町中学校1976年卒業同窓会</p>
                    </div>
                    <div>
                        <span id="admin-user-name" style="margin-right: 15px;">管理者</span>
                        <button onclick="adminLogout()" style="background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">ログアウト</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="admin-container">
            <!-- 統計情報 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-users">-</div>
                    <div class="stat-label">登録ユーザー数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-messages">-</div>
                    <div class="stat-label">投稿メッセージ数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-photos">-</div>
                    <div class="stat-label">アップロード写真数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-rsvp">-</div>
                    <div class="stat-label">出欠回答数</div>
                </div>
            </div>

            <!-- タブメニュー -->
            <div class="admin-tabs">
                <button class="admin-tab active" onclick="showAdminTab('users')">ユーザー管理</button>
                <button class="admin-tab" onclick="showAdminTab('messages')">メッセージ管理</button>
                <button class="admin-tab" onclick="showAdminTab('photos')">写真管理</button>
                <button class="admin-tab" onclick="showAdminTab('rsvp')">出欠管理</button>
                <button class="admin-tab" onclick="showAdminTab('settings')">設定</button>
            </div>

            <!-- ユーザー管理 -->
            <div id="admin-users" class="admin-content active">
                <div class="admin-card">
                    <h3>ユーザー管理</h3>
                    <div id="users-list-admin">
                        <p>ユーザーデータを読み込み中...</p>
                    </div>
                </div>
            </div>

            <!-- メッセージ管理 -->
            <div id="admin-messages" class="admin-content">
                <div class="admin-card">
                    <h3>メッセージ管理</h3>
                    <div id="messages-list-admin">
                        <p>メッセージデータを読み込み中...</p>
                    </div>
                </div>
            </div>

            <!-- 写真管理 -->
            <div id="admin-photos" class="admin-content">
                <div class="admin-card">
                    <h3>写真管理</h3>
                    <div id="photos-list-admin">
                        <p>写真データを読み込み中...</p>
                    </div>
                </div>
            </div>

            <!-- 出欠管理 -->
            <div id="admin-rsvp" class="admin-content">
                <div class="admin-card">
                    <h3>出欠管理</h3>
                    <div id="rsvp-list-admin">
                        <p>出欠データを読み込み中...</p>
                    </div>
                </div>
            </div>

            <!-- 設定 -->
            <div id="admin-settings" class="admin-content">
                <div class="admin-card">
                    <h3>システム設定</h3>
                    <div class="form-group">
                        <label>サイト管理</label>
                        <button onclick="exportData()" class="btn-admin btn-edit">データエクスポート</button>
                        <button onclick="clearCache()" class="btn-admin btn-delete">キャッシュクリア</button>
                    </div>
                    <div class="form-group">
                        <label>管理者権限</label>
                        <p style="color: #666; font-size: 0.9rem;">
                            現在の管理者権限: <strong>フル管理者</strong><br>
                            すべてのコンテンツとユーザーを管理できます。
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            getDocs, 
            doc, 
            getDoc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot,
            orderBy,
            query 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase設定を使用
        const firebaseConfig = window.FIREBASE_CONFIG;

        // Firebase初期化
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentAdmin = null;

        // 管理者権限チェック
        const ADMIN_EMAILS = [
            'admin@sakuramachi1976.com',
            'kanri@sakuramachi1976.com',
            'test@admin.com'  // テスト用
        ];

        // 認証状態の監視
        onAuthStateChanged(auth, async (user) => {
            if (user && ADMIN_EMAILS.includes(user.email)) {
                currentAdmin = user;
                await loadAdminProfile(user.uid);
                showAdminDashboard();
            } else if (user) {
                // 一般ユーザー
                showAccessDenied();
            } else {
                // 未ログイン
                showAdminLoginScreen();
            }
        });

        // UI表示制御
        function showAdminLoginScreen() {
            document.getElementById('admin-login-screen').style.display = 'block';
            document.getElementById('access-denied-screen').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'none';
        }

        function showAccessDenied() {
            document.getElementById('admin-login-screen').style.display = 'none';
            document.getElementById('access-denied-screen').style.display = 'block';
            document.getElementById('admin-dashboard').style.display = 'none';
        }

        function showAdminDashboard() {
            document.getElementById('admin-login-screen').style.display = 'none';
            document.getElementById('access-denied-screen').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'block';
            loadAllAdminData();
        }

        // 管理者ログイン
        window.adminLogin = async function() {
            const email = document.getElementById('admin-email').value.trim();
            const password = document.getElementById('admin-password').value;

            if (!email || !password) {
                showAdminError('メールアドレスとパスワードを入力してください。');
                return;
            }

            if (!ADMIN_EMAILS.includes(email)) {
                showAdminError('管理者権限がありません。');
                return;
            }

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error('Admin login error:', error);
                showAdminError('ログインに失敗しました: ' + error.message);
            }
        };

        // 管理者ログアウト
        window.adminLogout = async function() {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Admin logout error:', error);
            }
        };

        // 管理者プロフィール読み込み
        async function loadAdminProfile(uid) {
            try {
                const userDoc = await getDoc(doc(db, 'users', uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    document.getElementById('admin-user-name').textContent = userData.name || 'Admin';
                }
            } catch (error) {
                console.error('Error loading admin profile:', error);
            }
        }

        // 統計データとコンテンツ読み込み
        async function loadAllAdminData() {
            loadStats();
            loadUsersAdmin();
            loadMessagesAdmin();
            loadPhotosAdmin();
            loadRSVPAdmin();
        }

        async function loadStats() {
            try {
                // ユーザー数
                const usersSnapshot = await getDocs(collection(db, 'users'));
                document.getElementById('total-users').textContent = usersSnapshot.size;

                // メッセージ数
                const messagesSnapshot = await getDocs(collection(db, 'messages'));
                document.getElementById('total-messages').textContent = messagesSnapshot.size;

                // 写真数
                const photosSnapshot = await getDocs(collection(db, 'photos'));
                document.getElementById('total-photos').textContent = photosSnapshot.size;

                // 出欠回答数
                const rsvpSnapshot = await getDocs(collection(db, 'rsvp'));
                document.getElementById('total-rsvp').textContent = rsvpSnapshot.size;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadUsersAdmin() {
            try {
                const querySnapshot = await getDocs(collection(db, 'users'));
                const container = document.getElementById('users-list-admin');
                container.innerHTML = '';

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const userElement = createUserAdminElement(doc.id, data);
                    container.appendChild(userElement);
                });
            } catch (error) {
                console.error('Error loading users for admin:', error);
            }
        }

        function createUserAdminElement(id, data) {
            const div = document.createElement('div');
            div.className = 'user-item';
            
            const roleText = data.role === 'admin' ? ' (管理者)' : '';
            const publicText = data.isPublic ? '公開' : '非公開';
            
            div.innerHTML = `
                <div class="user-info">
                    <div class="user-name">${escapeHtml(data.name || '未設定')}${roleText}</div>
                    <div class="user-details">
                        ${escapeHtml(data.email)} | ${escapeHtml(data.graduationYear || '未設定')} | 
                        ${escapeHtml(data.address || '未設定')} | ${publicText}
                    </div>
                </div>
                <div class="admin-actions">
                    <button class="btn-admin btn-edit" onclick="editUser('${id}')">編集</button>
                    <button class="btn-admin btn-delete" onclick="deleteUser('${id}')">削除</button>
                </div>
            `;
            return div;
        }

        async function loadMessagesAdmin() {
            try {
                const q = query(collection(db, 'messages'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                const container = document.getElementById('messages-list-admin');
                container.innerHTML = '';

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const messageElement = createMessageAdminElement(doc.id, data);
                    container.appendChild(messageElement);
                });
            } catch (error) {
                console.error('Error loading messages for admin:', error);
            }
        }

        function createMessageAdminElement(id, data) {
            const div = document.createElement('div');
            div.className = 'content-item';
            
            let dateStr = '不明';
            if (data.createdAt && data.createdAt.toDate) {
                dateStr = data.createdAt.toDate().toLocaleString('ja-JP');
            }
            
            const messagePreview = data.message.length > 100 ? 
                data.message.substring(0, 100) + '...' : data.message;
            
            div.innerHTML = `
                <div class="user-info">
                    <div class="user-name">メッセージ by ${escapeHtml(data.userName)}</div>
                    <div class="user-details">
                        ${escapeHtml(messagePreview)}<br>
                        投稿日時: ${dateStr}
                    </div>
                </div>
                <div class="admin-actions">
                    <button class="btn-admin btn-delete" onclick="deleteMessage('${id}')">削除</button>
                </div>
            `;
            return div;
        }

        async function loadPhotosAdmin() {
            try {
                const q = query(collection(db, 'photos'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                const container = document.getElementById('photos-list-admin');
                container.innerHTML = '';

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const photoElement = createPhotoAdminElement(doc.id, data);
                    container.appendChild(photoElement);
                });
            } catch (error) {
                console.error('Error loading photos for admin:', error);
            }
        }

        function createPhotoAdminElement(id, data) {
            const div = document.createElement('div');
            div.className = 'content-item';
            
            let dateStr = '不明';
            if (data.createdAt && data.createdAt.toDate) {
                dateStr = data.createdAt.toDate().toLocaleString('ja-JP');
            }
            
            div.innerHTML = `
                <div class="user-info">
                    <div class="user-name">写真: ${escapeHtml(data.title)}</div>
                    <div class="user-details">
                        投稿者: ${escapeHtml(data.userName)}<br>
                        説明: ${escapeHtml(data.description || '説明なし')}<br>
                        投稿日時: ${dateStr}
                    </div>
                </div>
                <div class="admin-actions">
                    <button class="btn-admin btn-edit" onclick="viewPhoto('${data.imageUrl}', '${escapeHtml(data.title)}')">表示</button>
                    <button class="btn-admin btn-delete" onclick="deletePhoto('${id}')">削除</button>
                </div>
            `;
            return div;
        }

        async function loadRSVPAdmin() {
            try {
                const q = query(collection(db, 'rsvp'), orderBy('createdAt', 'desc'));
                const querySnapshot = await getDocs(q);
                const container = document.getElementById('rsvp-list-admin');
                container.innerHTML = '';

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const rsvpElement = createRSVPAdminElement(doc.id, data);
                    container.appendChild(rsvpElement);
                });
            } catch (error) {
                console.error('Error loading RSVP for admin:', error);
            }
        }

        function createRSVPAdminElement(id, data) {
            const div = document.createElement('div');
            div.className = 'content-item';
            
            let dateStr = '不明';
            if (data.createdAt && data.createdAt.toDate) {
                dateStr = data.createdAt.toDate().toLocaleString('ja-JP');
            }
            
            const eventName = data.eventType === 'kanreki-2030' ? '2030年還暦同窓会' : 
                            data.eventType === 'bunkasai-2025' ? '2025年母校文化祭見学' : data.eventType;
            
            const attendanceText = data.attendance === 'participate' ? '参加予定' :
                                 data.attendance === 'not-participate' ? '不参加' : '未定';
            
            div.innerHTML = `
                <div class="user-info">
                    <div class="user-name">${escapeHtml(data.userName)} - ${eventName}</div>
                    <div class="user-details">
                        回答: ${attendanceText}<br>
                        コメント: ${escapeHtml(data.comment || 'なし')}<br>
                        回答日時: ${dateStr}
                    </div>
                </div>
                <div class="admin-actions">
                    <button class="btn-admin btn-delete" onclick="deleteRSVP('${id}')">削除</button>
                </div>
            `;
            return div;
        }

        // タブ切り替え
        window.showAdminTab = function(tabName) {
            // タブボタンの切り替え
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // コンテンツの切り替え
            document.querySelectorAll('.admin-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('admin-' + tabName).classList.add('active');
        };

        // 管理アクション
        window.editUser = function(userId) {
            alert(`ユーザー編集機能（ユーザーID: ${userId}）\n今後実装予定です。`);
        };

        window.deleteUser = async function(userId) {
            if (!confirm('このユーザーを削除しますか？この操作は取り消せません。')) return;
            
            try {
                await deleteDoc(doc(db, 'users', userId));
                alert('ユーザーを削除しました。');
                loadUsersAdmin();
                loadStats();
            } catch (error) {
                console.error('Error deleting user:', error);
                alert('削除に失敗しました。');
            }
        };

        window.deleteMessage = async function(messageId) {
            if (!confirm('このメッセージを削除しますか？')) return;
            
            try {
                await deleteDoc(doc(db, 'messages', messageId));
                alert('メッセージを削除しました。');
                loadMessagesAdmin();
                loadStats();
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('削除に失敗しました。');
            }
        };

        window.deletePhoto = async function(photoId) {
            if (!confirm('この写真を削除しますか？')) return;
            
            try {
                await deleteDoc(doc(db, 'photos', photoId));
                alert('写真を削除しました。');
                loadPhotosAdmin();
                loadStats();
            } catch (error) {
                console.error('Error deleting photo:', error);
                alert('削除に失敗しました。');
            }
        };

        window.deleteRSVP = async function(rsvpId) {
            if (!confirm('この出欠回答を削除しますか？')) return;
            
            try {
                await deleteDoc(doc(db, 'rsvp', rsvpId));
                alert('出欠回答を削除しました。');
                loadRSVPAdmin();
                loadStats();
            } catch (error) {
                console.error('Error deleting RSVP:', error);
                alert('削除に失敗しました。');
            }
        };

        window.viewPhoto = function(imageUrl, title) {
            window.open(imageUrl, '_blank');
        };

        window.exportData = function() {
            alert('データエクスポート機能は今後実装予定です。');
        };

        window.clearCache = function() {
            if (confirm('キャッシュをクリアしますか？')) {
                localStorage.clear();
                sessionStorage.clear();
                alert('キャッシュをクリアしました。');
            }
        };

        // ユーティリティ関数
        function showAdminError(message) {
            const errorElement = document.getElementById('admin-error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>